<!DOCTYPE html>
<html>
<head>
    <title>Your Pantry</title>
    <style>
        body {
            font-family: Arial;
            background: #f4f6f9;
            padding: 40px;
        }

        .pantry-container {
            max-width: 700px;
            margin: auto;
        }

        .item-card {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: relative;
            transition: opacity 0.2s ease;
        }

        .expired { border-left: 6px solid red; }
        .safe { border-left: 6px solid green; }
        .soon { border-left: 6px solid orange; }

        .deleteBtn {
            position: absolute;
            right: 20px;
            top: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .deleteBtn:hover { opacity: 0.85; }

        .expiry-badge {
            background: #13182e;
            color: white;
            padding: 12px 18px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
        }

        .hidden { display: none; }

        .empty-message {
            text-align: center;
            font-size: 18px;
            color: #666;
            margin-top: 40px;
        }
    </style>
</head>
<body>

<div class="pantry-container">

    <div>
        <a href="/">Home</a>
        <a href="/logout">Logout</a>
    </div>

    <h2>{{ session.get('username') }}'s Pantry</h2>

    <!-- Stats Badge -->
    <div id="expiryBadge" class="expiry-badge hidden">
        <span id="badgeExpired"></span>
        <span id="badgeSoon"></span>
        <span id="badgeSafe"></span>
        <span id="badgeTotal"></span>
    </div>

    {% if items %}
        {% for item in items %}
            {% set status_class = "safe" %}
            {% if item.days_left < 0 %}
                {% set status_class = "expired" %}
            {% elif item.days_left <= 3 %}
                {% set status_class = "soon" %}
            {% endif %}

            <div class="item-card {{ status_class }}">
                <strong>{{ item.product }}</strong><br>
                Expiry Date: {{ item.expiry_date }}<br>

                {% if item.days_left < 0 %}
                    âŒ Expired {{ item.days_left|abs }} day(s) ago
                {% else %}
                    âœ… {{ item.days_left }} day(s) left
                {% endif %}

                <button class="deleteBtn" data-id="{{ item.id }}">
                    Delete
                </button>
            </div>

        {% endfor %}
    {% else %}
        <div class="empty-message">
            Your Pantry is Empty. Start saving items.ðŸ¥² 
        </div>
    {% endif %}

</div>

<script>

// LOAD STATS
async function loadPantryStats() {
    const res = await fetch('/pantry-stats');
    const data = await res.json();

    const badge = document.getElementById('expiryBadge');
    badge.classList.remove('hidden');

    document.getElementById('badgeExpired').innerText = `ðŸ”´ Expired: ${data.expired}`;
    document.getElementById('badgeSoon').innerText = `ðŸŸ¡ Soon: ${data.soon}`;
    document.getElementById('badgeSafe').innerText = `ðŸŸ¢ Safe: ${data.safe}`;
    document.getElementById('badgeTotal').innerText = `ðŸ“¦ Total: ${data.total}`;
}

loadPantryStats();


// FAST DELETE (Optimistic UI)
document.querySelectorAll('.deleteBtn').forEach(btn => {
    btn.addEventListener('click', async function() {

        const card = this.closest('.item-card');
        const itemId = this.dataset.id;

        // remove instantly
        card.style.opacity = "0.4";

        const res = await fetch('/delete-from-pantry', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ item_id: itemId })
        });

        const data = await res.json();

        if (data.status === "success") {
            card.remove();
            loadPantryStats();
        } else {
            card.style.opacity = "1";
            alert(data.message);
        }
    });
});

</script>

</body>
</html>
